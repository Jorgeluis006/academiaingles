<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin</title>
    <link rel="stylesheet" href="css/bootstrap-5.0.2-dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/palette.css">
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <header class="bg-light py-3">
        <div class="container d-flex justify-content-between align-items-center">
            <h1 class="h4 mb-0" style="color: var(--color-purple);">Atisbe</h1>
            <nav>
                <a href="index.html" class="btn btn-link" style="color: var(--color-dark);">Inicio</a>
                <a href="quienessomos.html" class="btn btn-link" style="color: var(--color-dark);">Quiénes somos</a>
                <a href="cursos.html" class="btn btn-warning" style="background: var(--color-yellow); color: var(--color-dark);">Nuestros cursos</a>
                <a href="login.html" class="btn btn-outline-primary" style="color: var(--color-purple); border-color: var(--color-purple);">Login</a>
            </nav>
        </div>
    </header>
    <main>
        <div class="container py-5">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h2 class="mb-4 text-center" style="color: var(--color-purple);">Panel de Administración</h2>
                            <div class="alert alert-info text-center" style="background: var(--color-mauve); color: var(--color-dark);">
                                Gestión de cursos: edita, elimina o agrega nuevos cursos para la web.
                            </div>
                            <div id="cursos-admin">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h4 class="mb-0" style="color: var(--color-purple);">Cursos actuales</h4>
                                    <button class="btn btn-success" id="btn-nuevo-curso" type="button">Agregar curso</button>
                                </div>
                                <div id="cursos-lista" class="row g-4"></div>
                                <div id="form-curso" class="mt-4 d-none">
                                    <h5 id="form-titulo">Agregar nuevo curso</h5>
                                    <form id="cursoForm">
                                        <input type="hidden" id="curso-id">
                                        <div class="mb-2">
                                            <label class="form-label">Título</label>
                                            <input type="text" class="form-control" id="curso-titulo" required>
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label">Descripción</label>
                                            <textarea class="form-control" id="curso-desc" rows="2" required></textarea>
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label">URL de imagen</label>
                                            <input type="url" class="form-control" id="curso-img" required>
                                        </div>
                                        <div class="mb-2">
                                            <img id="img-preview" src="" alt="Previsualización" style="max-width:180px;max-height:120px;display:none;border-radius:1rem;">
                                        </div>
                                        <button type="submit" class="btn btn-primary">Guardar</button>
                                        <button type="button" class="btn btn-secondary ms-2" id="cancelar-curso">Cancelar</button>
                                    </form>
                                </div>
                                <!-- Testimonios admin -->
                                <hr>
                                <div id="testimonios-admin" class="mt-4">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h4 class="mb-0" style="color: var(--color-purple);">Testimonios</h4>
                                        <button class="btn btn-success" id="btn-nuevo-testimonio" type="button">Agregar testimonio</button>
                                    </div>
                                    <div id="testimonios-lista" class="row g-4"></div>
                                    <div id="form-testimonio" class="mt-4 d-none">
                                        <h5 id="form-testimonio-titulo">Agregar testimonio</h5>
                                        <form id="testimonioForm">
                                            <input type="hidden" id="testimonio-id">
                                            <div class="mb-2">
                                                <label class="form-label">Nombre</label>
                                                <input type="text" class="form-control" id="testimonio-nombre" required>
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label">Contenido</label>
                                                <textarea class="form-control" id="testimonio-contenido" rows="2" required></textarea>
                                            </div>
                                            <div class="mb-2">
                                                <label class="form-label">URL de video (opcional)</label>
                                                <input type="url" class="form-control" id="testimonio-video">
                                            </div>
                                            <button type="submit" class="btn btn-primary">Guardar</button>
                                            <button type="button" class="btn btn-secondary ms-2" id="cancelar-testimonio">Cancelar</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <script src="css/bootstrap-5.0.2-dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Toast visual con fallback a alert si no existe el elemento
        function showToast(msg, success = true) {
            const toast = document.getElementById('toast-admin');
            if (!toast) {
                // fallback simple para entornos donde no se haya definido el toast
                console.log('TOAST: ', msg, success);
                alert(msg);
                return;
            }
            const toastMsg = document.getElementById('toast-admin-msg');
            toastMsg.textContent = msg;
            toast.classList.remove('text-bg-success', 'text-bg-danger');
            toast.classList.add(success ? 'text-bg-success' : 'text-bg-danger');
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }
    // --- Gestión de cursos ---
    const cursosLista = document.getElementById('cursos-lista');
    const formCurso = document.getElementById('form-curso');
    const btnNuevoCurso = document.getElementById('btn-nuevo-curso');
    const cursoForm = document.getElementById('cursoForm');
    const cancelarCurso = document.getElementById('cancelar-curso');
    const imgPreview = document.getElementById('img-preview');
    let editando = false;
    let cursos = [];

    function renderCursos() {
        cursosLista.innerHTML = '';
        cursos.forEach(curso => {
            const col = document.createElement('div');
            col.className = 'col-12 col-md-6 col-lg-4';
            col.innerHTML = `
                <div class="card curso-card mb-3 shadow-sm">
                    <img src="${curso.imagen}" alt="${curso.titulo}" style="height:160px;object-fit:cover;border-radius:1.2rem 1.2rem 0 0;">
                    <div class="card-body">
                        <h5 class="card-title">${curso.titulo}</h5>
                        <p class="card-text">${curso.descripcion}</p>
                        <button class="btn btn-sm btn-warning me-2" onclick="editarCurso(${curso.id})">Editar</button>
                        <button class="btn btn-sm btn-danger" onclick="eliminarCurso(${curso.id})">Eliminar</button>
                    </div>
                </div>
            `;
            cursosLista.appendChild(col);
        });
    // Fin de renderCursos
// Definir eliminarCurso solo una vez
window.eliminarCurso = function(id) {
    if (!confirm('¿Seguro que deseas eliminar este curso?')) return;
    const formData = new FormData();
    formData.append('id', id);
    fetch('php/cursos.php?action=eliminar', {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            cargarCursos();
            showToast('Curso eliminado correctamente', true);
        } else {
            showToast(data.msg || 'Error al eliminar', false);
        }
    });
}
    }

    function cargarCursos() {
        fetch('php/cursos.php?action=listar')
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    cursos = data.cursos;
                    renderCursos();
                }
            });
    }

    window.editarCurso = function(id) {
        const curso = cursos.find(c => c.id == id);
        if (!curso) return;
        document.getElementById('curso-id').value = curso.id;
        document.getElementById('curso-titulo').value = curso.titulo;
        document.getElementById('curso-desc').value = curso.descripcion;
        document.getElementById('curso-img').value = curso.imagen;
        imgPreview.src = curso.imagen;
        imgPreview.style.display = 'block';
        document.getElementById('form-titulo').textContent = 'Editar curso';
        formCurso.classList.remove('d-none');
        editando = true;
    }

    btnNuevoCurso.onclick = () => {
        cursoForm.reset();
        document.getElementById('curso-id').value = '';
        imgPreview.style.display = 'none';
        document.getElementById('form-titulo').textContent = 'Agregar nuevo curso';
        formCurso.classList.remove('d-none');
        editando = false;
    };

    cancelarCurso.onclick = () => {
        formCurso.classList.add('d-none');
    };

    document.getElementById('curso-img').oninput = function() {
        if (this.value) {
            imgPreview.src = this.value;
            imgPreview.style.display = 'block';
        } else {
            imgPreview.style.display = 'none';
        }
    };

    cursoForm.onsubmit = function(e) {
        e.preventDefault();
        const id = document.getElementById('curso-id').value;
        const titulo = document.getElementById('curso-titulo').value.trim();
        const descripcion = document.getElementById('curso-desc').value.trim();
        const imagen = document.getElementById('curso-img').value.trim();
        const formData = new FormData();
        formData.append('titulo', titulo);
        formData.append('descripcion', descripcion);
        formData.append('imagen', imagen);
        if (editando) {
            formData.append('id', id);
        }
        fetch('php/cursos.php?action=' + (editando ? 'editar' : 'agregar'), {
            method: 'POST',
            body: formData
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                formCurso.classList.add('d-none');
                cargarCursos();
                showToast(editando ? 'Curso editado correctamente' : 'Curso agregado correctamente', true);
            } else {
                showToast(data.msg || 'Error al guardar', false);
            }
        });
    };

    cargarCursos();
    // --- Gestión de testimonios ---
    const testimoniosLista = document.getElementById('testimonios-lista');
    const formTestimonio = document.getElementById('form-testimonio');
    const btnNuevoTestimonio = document.getElementById('btn-nuevo-testimonio');
    const testimonioForm = document.getElementById('testimonioForm');
    const cancelarTestimonio = document.getElementById('cancelar-testimonio');
    let editandoTestimonio = false;
    let testimonios = [];

    function renderTestimonios() {
        testimoniosLista.innerHTML = '';
        testimonios.forEach(t => {
            const col = document.createElement('div');
            col.className = 'col-12';
            col.innerHTML = `
                <div class="card mb-3 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">${t.nombre}</h5>
                        <p class="card-text">${t.contenido}</p>
                        ${t.video_url ? `<div class="ratio ratio-16x9 mb-2"><iframe src="${t.video_url}" title="video" allowfullscreen></iframe></div>` : ''}
                        <button class="btn btn-sm btn-warning me-2" onclick="editarTestimonio(${t.id})">Editar</button>
                        <button class="btn btn-sm btn-danger" onclick="eliminarTestimonio(${t.id})">Eliminar</button>
                    </div>
                </div>
            `;
            testimoniosLista.appendChild(col);
        });
    }

    function cargarTestimonios() {
        fetch('php/testimonios.php?action=listar')
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    testimonios = data.testimonios;
                    renderTestimonios();
                }
            });
    }

    window.editarTestimonio = function(id) {
        const t = testimonios.find(x => x.id == id);
        if (!t) return;
        document.getElementById('testimonio-id').value = t.id;
        document.getElementById('testimonio-nombre').value = t.nombre;
        document.getElementById('testimonio-contenido').value = t.contenido;
        document.getElementById('testimonio-video').value = t.video_url;
        document.getElementById('form-testimonio-titulo').textContent = 'Editar testimonio';
        formTestimonio.classList.remove('d-none');
        editandoTestimonio = true;
    }

    window.eliminarTestimonio = function(id) {
        if (!confirm('¿Seguro que deseas eliminar este testimonio?')) return;
        const formData = new FormData();
        formData.append('id', id);
        fetch('php/testimonios.php?action=eliminar', { method: 'POST', body: formData })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    cargarTestimonios();
                    showToast('Testimonio eliminado', true);
                } else {
                    showToast(data.msg || 'Error al eliminar', false);
                }
            });
    }

    btnNuevoTestimonio.onclick = () => {
        testimonioForm.reset();
        document.getElementById('testimonio-id').value = '';
        document.getElementById('form-testimonio-titulo').textContent = 'Agregar testimonio';
        formTestimonio.classList.remove('d-none');
        editandoTestimonio = false;
    };

    cancelarTestimonio.onclick = () => {
        formTestimonio.classList.add('d-none');
    };

        testimonioForm.onsubmit = function(e) {
        e.preventDefault();
        const id = document.getElementById('testimonio-id').value;
        const nombre = document.getElementById('testimonio-nombre').value.trim();
        const contenido = document.getElementById('testimonio-contenido').value.trim();
        const video_url = document.getElementById('testimonio-video').value.trim();
        const formData = new FormData();
        formData.append('nombre', nombre);
        formData.append('contenido', contenido);
        formData.append('video_url', video_url);
        if (editandoTestimonio) formData.append('id', id);
        fetch('php/testimonios.php?action=' + (editandoTestimonio ? 'editar' : 'agregar'), { method: 'POST', body: formData })
            .then(async r => {
                const text = await r.text();
                let body = null;
                try {
                    body = text ? JSON.parse(text) : null;
                } catch (e) {
                    console.error('Respuesta inválida (no JSON):', text);
                    showToast('Respuesta inválida del servidor: ' + (text.length > 200 ? text.slice(0, 200) + '...' : text), false);
                    throw new Error('Invalid JSON');
                }
                return { status: r.status, ok: r.ok, body };
            })
            .then(resp => {
                console.log('RESPUESTA TESTIMONIOS:', resp);
                if (resp.body && resp.body.success) {
                    formTestimonio.classList.add('d-none');
                    cargarTestimonios();
                    showToast(editandoTestimonio ? 'Testimonio editado' : 'Testimonio agregado', true);
                } else {
                    const msg = (resp.body && resp.body.msg) ? resp.body.msg : 'Error al guardar';
                    showToast(msg, false);
                }
            }).catch(err => {
                console.error('Error al conectar con la API de testimonios:', err);
                // Si es un error de red o parsing ya se mostró, aquí mostramos un genérico
                showToast('Error de conexión al guardar testimonio', false);
            });
    };

    cargarTestimonios();
    </script>
    <script src="js/main.js"></script>
</body>
</html>